<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[I'm Durrell Chamorro]]></title>
  <link href="http://durrellchamorro.github.io/atom.xml" rel="self"/>
  <link href="http://durrellchamorro.github.io/"/>
  <updated>2016-01-31T22:34:14-08:00</updated>
  <id>http://durrellchamorro.github.io/</id>
  <author>
    <name><![CDATA[Durrell Chamorro]]></name>
    <email><![CDATA[durrell.chamorro@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Using Procs to DRY Up Ruby Code]]></title>
    <link href="http://durrellchamorro.github.io/blog/2016/01/30/use-procs-to-dry-up-code/"/>
    <updated>2016-01-30T22:58:51-08:00</updated>
    <id>http://durrellchamorro.github.io/blog/2016/01/30/use-procs-to-dry-up-code</id>
    <content type="html"><![CDATA[<p>Ruby code is full of blocks. Blocks are essentially chunks of code that allow you to defer
the precise way a method will work to the time of the method invocation. For example,
if you encounter a scenario where you&rsquo;re calling a method from multiple places,
with one little tweak in each case, it may be a good idea implement the
method in a generic way by yielding to a block. By defining one method instead of many similar
methods your code stays DRY. The problem is Ruby only lets you
yield to one block per method and that limits your ability to customize methods. In this post
I&rsquo;ll explain how to send procs to methods so you can customize your generic methods in
more than one way at a time.  Along the way I explain
how some of Ruby&rsquo;s syntactic sugar works, and I close with a real world example of how I implemented
all this in an app. <!--more--></p>

<p>In the context of a method call, putting an ampersand in front of the
<a href="#LastArgument">*last argument</a>
tells Ruby to convert whatever is immediately to the right of the ampersand
to a proc if it isn&rsquo;t a proc already and then use that proc as the method’s block.
For example, these 5 examples all return the same thing:</p>

<p>1) The traditional way:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">n</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span> <span class="c1"># =&gt; [&quot;1&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>2) Below the ampersand calls <code>Symbol#to_proc</code> on <code>:to_s</code> and then makes sure that proc is used as the method&rsquo;s block.
Click <a href="#SymbolToProc">here</a> for an explanation of how <code>Symbol#to_proc</code> works.
<a name="LastArgument"></a>*Technically speaking, Ruby does not consider the ampersand followed by a proc (or in this case a symbol being
converted to a proc) to be an argument for the method. If it did, then this would cause a wrong number of arguments
(1 for 0) error since <code>Array#map</code> doesn&rsquo;t take any arguments.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span> <span class="c1"># =&gt; [&quot;1&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>3) Since <code>a_proc</code> is already a proc, the ampersand doesn&rsquo;t need to call <code>#to_proc</code> on it. Instead it will just make
sure the proc is used as the method&rsquo;s block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">a_proc</span> <span class="o">=</span> <span class="ss">:to_s</span><span class="o">.</span><span class="n">to_proc</span>
</span><span class='line'><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a_proc</span><span class="p">)</span> <span class="c1"># =&gt; [&quot;1&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>4) You can create a proc and assign it to a local variable that describes what the proc does:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">call_to_s_on_the_object</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">object</span><span class="o">|</span> <span class="n">object</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
</span><span class='line'><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">call_to_s_on_the_object</span><span class="p">)</span> <span class="c1"># =&gt; [&quot;1&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>5) Instead of <code>Proc.new</code> you can just write this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">a_shorter_way_to_create_a_proc</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span> <span class="o">|</span><span class="n">object</span><span class="o">|</span> <span class="n">object</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
</span><span class='line'><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a_shorter_way_to_create_a_proc</span><span class="p">)</span> <span class="c1"># =&gt; [&quot;1&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Procs do more than just give us syntactic sugar.
<a href="#RealWorldExample">They helped me combine two methods into one.</a>
If you have two methods that are the same, except for a block inside the methods and both methods are
already yielding to a block like below, you can&rsquo;t yield to two different blocks, but you can
pass in a proc to handle the difference. Below are three methods. The first two can be replaced by the third.
<a href="https://gist.github.com/durrellchamorro/220045206c525bd72f78">Here is code</a> you
can run in your terminal to see how all the examples in this post work firsthand.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">my_first_method</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'>  <span class="n">array</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">string</span><span class="o">|</span> <span class="nb">p</span> <span class="n">string</span> <span class="o">+</span> <span class="s1">&#39; whatever&#39;</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">array</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">object</span><span class="o">|</span> <span class="nb">p</span> <span class="k">yield</span> <span class="n">object</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">my_second_method</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'>  <span class="n">array</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">object</span><span class="o">|</span> <span class="nb">p</span> <span class="n">object</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">array</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">object</span><span class="o">|</span> <span class="nb">p</span> <span class="k">yield</span> <span class="n">object</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">you_only_need_one_method</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">some_proc</span><span class="p">)</span>
</span><span class='line'>  <span class="n">array</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">some_proc</span><span class="p">)</span>
</span><span class='line'>  <span class="n">array</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">object</span><span class="o">|</span> <span class="nb">p</span> <span class="k">yield</span> <span class="n">object</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><a name="SymbolToProc"></a></p>

<h3>The Symbol class defines <code>#to_proc</code> like so:</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Symbol</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_proc</span>
</span><span class='line'>    <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="o">|</span> <span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Therefore, calling <code>#to_proc</code> on a symbol returns a proc.
<code>[1, 2].to_s</code> is the same as <code>[1, 2].send(:to_s)</code>.
Likewise, <code>[1, 2].delete_at(0)</code> is the same as <code>[1, 2].send(:delete_at, 0)</code>.
With this in mind, consider the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">foo!</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</span><span class='line'>  <span class="k">yield</span> <span class="n">array</span><span class="p">,</span> <span class="n">index</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">my_array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">foo!</span><span class="p">(</span><span class="n">my_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="ss">:delete_at</span><span class="p">)</span> <span class="c1"># This is the same as: my_array.delete_at(0)</span>
</span><span class='line'>
</span><span class='line'><span class="n">my_array</span> <span class="c1"># =&gt; [2]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code below proves <code>delete_at_proc</code> and <code>delete_at_proc2</code> are equivalent:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">delete_at_proc</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">obj</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span> <span class="n">obj</span><span class="o">.</span><span class="n">delete_at</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="n">my_array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">foo!</span><span class="p">(</span><span class="n">my_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delete_at_proc</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">my_array</span> <span class="c1"># =&gt; [2]</span>
</span><span class='line'>
</span><span class='line'><span class="n">delete_at_proc2</span> <span class="o">=</span> <span class="ss">:delete_at</span><span class="o">.</span><span class="n">to_proc</span>
</span><span class='line'><span class="n">my_array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">foo!</span><span class="p">(</span><span class="n">my_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delete_at_proc2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">my_array</span> <span class="c1"># =&gt; [2]</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a name="RealWorldExample"></a> A Real World Example of all this in Action</h3>

<p>The <code>#sort</code> helper method below is written in a generic way so two things can be customized
at method invocation time.</p>

<h4>1. The collection can be any object that can be sent <code>#partition</code> and <code>#index</code>.</h4>

<h4>2. The block being yielded to can be customized.</h4>

<p><code>#sort</code> uses <code>#partition</code> to split a collection into two arrays: complete and incomplete. <code>#partition</code>
iterates through each element in the collection and decides
which array each element of the collection will go to depending
on whether <code>#partition</code>&rsquo;s' block evaluates to true. Next, <code>#sort</code>
yields each item in the newly created arrays with its original index to the block in a view. Therefore,
I needed a different way to check the status of different kinds of collections
in order for <code>#partition</code>&rsquo;s block to evaluate to true or false for the different kinds collections.
Instead of defining a sorting method for each kind of collection that would use a unique block for <code>#partition</code>
made special to evaluate the status of that particular collection&rsquo;s elements, I created unique procs
for each kind of collection and used those procs for <code>#partition</code>&rsquo;s block. In this way
I was able to write one method that can sort different kinds of collections and then send the sorted collection&rsquo;s
items to a custom block.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">check_item_status</span><span class="p">)</span>
</span><span class='line'>  <span class="n">complete_collection</span><span class="p">,</span> <span class="n">incomplete_collection</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">check_item_status</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">incomplete_collection</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="k">yield</span> <span class="n">item</span><span class="p">,</span> <span class="n">collection</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">complete_collection</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="k">yield</span> <span class="n">item</span><span class="p">,</span> <span class="n">collection</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this view <code>#sort</code> yields to a custom block of erb code that displays the contents of
one kind of collection (todo items) in an unordered list:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%</span> <span class="n">check_todo_status</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span> <span class="o">|</span><span class="n">todo</span><span class="o">|</span> <span class="n">todo</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;complete&#39;</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="cp">&lt;%</span> <span class="n">sort</span><span class="p">(</span><span class="vi">@list</span><span class="o">[</span><span class="ss">:todos</span><span class="o">]</span><span class="p">,</span> <span class="n">check_todo_status</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">todo</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;ul&gt;</span>
</span><span class='line'><span class="x">    &lt;li class=&quot;</span><span class="cp">&lt;%=</span> <span class="n">todo</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x">&quot;&gt;</span>
</span><span class='line'><span class="x">      &lt;form action=&quot;/lists/</span><span class="cp">&lt;%=</span> <span class="vi">@list_id</span> <span class="cp">%&gt;</span><span class="x">/todos/</span><span class="cp">&lt;%=</span> <span class="n">index</span> <span class="cp">%&gt;</span><span class="x">&quot; method=&quot;post&quot; class=&quot;check&quot;&gt;</span>
</span><span class='line'><span class="x">        &lt;input type=&quot;hidden&quot; name=&quot;status&quot; value=&quot;</span><span class="cp">&lt;%=</span> <span class="n">opposite_status_of</span><span class="p">(</span><span class="n">todo</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x">&quot; &gt;</span>
</span><span class='line'><span class="x">        &lt;button type=&quot;submit&quot;&gt;Complete&lt;/button&gt;</span>
</span><span class='line'><span class="x">      &lt;/form&gt;</span>
</span><span class='line'><span class="x">      &lt;h3&gt;</span><span class="cp">&lt;%=</span> <span class="n">todo</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x">&lt;/h3&gt;</span>
</span><span class='line'><span class="x">      &lt;form action=&quot;/lists/</span><span class="cp">&lt;%=</span> <span class="vi">@list_id</span> <span class="cp">%&gt;</span><span class="x">/todos/</span><span class="cp">&lt;%=</span> <span class="n">index</span> <span class="cp">%&gt;</span><span class="x">/destroy&quot;</span>
</span><span class='line'><span class="x">        method=&quot;post&quot; class=&quot;delete&quot;&gt;</span>
</span><span class='line'><span class="x">        &lt;button type=&quot;submit&quot;&gt;Delete&lt;/button&gt;</span>
</span><span class='line'><span class="x">      &lt;/form&gt;</span>
</span><span class='line'><span class="x">    &lt;/li&gt;</span>
</span><span class='line'><span class="x">  &lt;/ul&gt;</span>
</span><span class='line'><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>In the view below <code>#sort</code> yields to a custom block of erb code that displays the contents of a
different kind of collection (a list of todo lists) in an unordered list.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;ul id=&quot;lists&quot;&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="n">check_list_status</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span> <span class="o">|</span><span class="n">list</span><span class="o">|</span> <span class="n">all_complete?</span><span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;complete&#39;</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="n">sort</span><span class="p">(</span><span class="vi">@lists</span><span class="p">,</span> <span class="n">check_list_status</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">list</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    &lt;li class=&quot;</span><span class="cp">&lt;%=</span><span class="n">all_complete?</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="cp">%&gt;</span><span class="x">&quot;&gt;</span>
</span><span class='line'><span class="x">      &lt;h2&gt;&lt;a href=&quot;lists/</span><span class="cp">&lt;%=</span> <span class="n">index</span> <span class="cp">%&gt;</span><span class="x">&quot;&gt;</span><span class="cp">&lt;%=</span> <span class="n">list</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x">&lt;/a&gt;&lt;/h2&gt;</span>
</span><span class='line'><span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">display_progress</span><span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">    &lt;/li&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/ul&gt;</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Generate Slugs]]></title>
    <link href="http://durrellchamorro.github.io/blog/2015/10/13/how-to-generate-slugs/"/>
    <updated>2015-10-13T20:06:52-07:00</updated>
    <id>http://durrellchamorro.github.io/blog/2015/10/13/how-to-generate-slugs</id>
    <content type="html"><![CDATA[<p>Slugs make pretty URLs. Pretty URLs help optimize your app for search engines and they
hide sensitive database information. In this post, I&rsquo;ll explain, line by line, one approach
to generating slugs. <!--more--></p>

<p>Here is the code I will explain. You might find it helpful to read this post in one window
while another window shows the module below in its entirety. That way as you read about
a line of code you can see that code in context in the other window. You can copy
the code below into a <code>sluggable.rb</code> file for your own project or include it as a gem by putting
<code>gem 'sluggable_durrell'</code> in your Gemfile.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Sluggable</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">before_save</span> <span class="ss">:generate_slug</span>
</span><span class='line'>    <span class="n">class_attribute</span> <span class="ss">:slug_column</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_param</span>
</span><span class='line'>    <span class="n">slug</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">generate_slug</span>
</span><span class='line'>    <span class="n">the_slug</span> <span class="o">=</span> <span class="n">to_slug</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">slug_column</span><span class="p">))</span>
</span><span class='line'>    <span class="n">object</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">slug</span><span class="p">:</span> <span class="n">the_slug</span><span class="p">)</span>
</span><span class='line'>    <span class="n">count</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>    <span class="k">while</span> <span class="n">object</span> <span class="o">&amp;&amp;</span> <span class="n">object</span> <span class="o">!=</span> <span class="nb">self</span>
</span><span class='line'>      <span class="n">the_slug</span> <span class="o">=</span> <span class="n">append_suffix</span><span class="p">(</span><span class="n">the_slug</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>      <span class="n">object</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">slug</span><span class="p">:</span> <span class="n">the_slug</span><span class="p">)</span>
</span><span class='line'>      <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">slug</span> <span class="o">=</span> <span class="n">the_slug</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">append_suffix</span><span class="p">(</span><span class="n">the_slug</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">the_slug</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">to_i</span> <span class="o">!=</span> <span class="mi">0</span>
</span><span class='line'>      <span class="n">the_slug</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">count</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">the_slug</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">count</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_slug</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">name</span><span class="o">.</span><span class="n">parameterize</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">sluggable_column</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">slug_column</span> <span class="o">=</span> <span class="n">column_name</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span></code></pre></td></tr></table></div></figure>


<p>To make a long story short, this line lets the methods
in the <code>Sluggable</code> module become instance methods of the class that includes the <code>Sluggable</code> module. It
also looks for a module named <code>ClassMethods</code> and includes the methods inside the <code>ClassMethods</code> module as
class methods of the class that includes the Sluggable module. Click <a href="http://www.fakingfantastic.com/2010/09/20/concerning-yourself-with-active-support-concern/">here</a>
for a more in depth explanation of how <code>ActiveSupport::Concern</code> works.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">included</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">before_save</span> <span class="ss">:generate_slug</span>
</span><span class='line'>  <span class="n">class_attribute</span> <span class="ss">:slug_column</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This fires the code inside the do block when the module is included in the class.
The <code>before_save</code> method tells the class to call <code>generate_slug</code> on each instance of the class
before the instance is saved. The <code>class_attribute</code> method adds an attribute named <code>slug_column</code> to the
class.</p>

<p>Let&rsquo;s say you have a Categories controller with a <code>show</code> action like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>  <span class="vi">@category</span> <span class="o">=</span> <span class="no">Category</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s say you have a corresponding view, <code>/views/categories/show.html.erb</code> and you have the line: <code>resources :categories</code>
in your <code>routes.rb</code> file which gives you a <code>category_path</code>
helper such that you can link to this show page like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="vi">@category</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">category_path</span><span class="p">(</span><span class="vi">@category</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>or if you prefer the shorter way:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="vi">@category</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="vi">@category</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>If you hover over the link with your mouse in Chrome, you will see the URL
that link points to in the bottom left hand corner of your browser. In this case
the development URL might look something like this:
<code>http://localhost:3000/categories/1</code>. This is what we would expect since if you go to
<code>http://localhost:3000/rails/info/routes</code> you will see the path for the <code>category_path</code> helper
is <code>/categories/:id(.:format)</code>.</p>

<p>The 1 at the end of the URL in the example above is the <code>:id</code> or in other words the
primary key for that particular category. How does the link know to point to the correct <code>:id</code> if
all it is given is the <code>@category</code> object? The trick is behind the scenes rails calls <code>to_param</code> on
<code>@category</code> and <code>to_param</code> returns the primary key in a string as shown below in the rails console.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">category</span> <span class="o">=</span> Category.first
</span><span class='line'>category.to_param
</span><span class='line'> <span class="o">=</span>&gt; <span class="s2">&quot;1&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>With that being said I can now explain why the <code>to_param</code> method is overridden in the Sluggable module:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">to_param</span>
</span><span class='line'>  <span class="n">slug</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead of returning the primary key of the category, we want to return the slug so the URL
will read like this instead <code>http://localhost:3000/categories/programming</code>. If you put a
<code>binding.pry</code> in the show action like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>   19: def <span class="nv">show</span>
</span><span class='line'><span class="o">=</span>&gt; 20:   binding.pry
</span><span class='line'>   21:   @category <span class="o">=</span> Category.find<span class="o">(</span>params<span class="o">[</span>:id<span class="o">])</span>
</span><span class='line'>   22: end
</span><span class='line'>
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> pry<span class="o">(</span><span class="c">#&lt;CategoriesController&gt;)&gt; params</span>
</span><span class='line'><span class="o">=</span>&gt; <span class="o">{</span><span class="s2">&quot;action&quot;</span><span class="o">=</span>&gt;<span class="s2">&quot;show&quot;</span>, <span class="s2">&quot;controller&quot;</span><span class="o">=</span>&gt;<span class="s2">&quot;categories&quot;</span>, <span class="s2">&quot;id&quot;</span><span class="o">=</span>&gt;<span class="s2">&quot;programming&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>you can see that the <code>:id</code> is now equal to the slug value instead of the primary key which is what we&rsquo;d
expect since we overrode the <code>to_param</code> method to return the slug instead of the primary key. In this example,
I already generated the slug for this category which is why it returned &ldquo;programming&rdquo;. Now I can explain how to
generate the slug.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">generate_slug</span>
</span><span class='line'>  <span class="n">the_slug</span> <span class="o">=</span> <span class="n">to_slug</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">slug_column</span><span class="p">))</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>self.class</code> returns the class of <code>self</code> so in our example <code>self.class.slug_column</code>
is the same as <code>Category.slug_column</code>. The reason we can call <code>slug_column</code> on the Category
class is because as I explained in the beginning, ActiveSupport::Concern looks for a module named ClassMethods
and includes all the methods inside that module as class methods of the class that includes the Sluggable module. In
our example the Category class/model looks something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Category</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Sluggable</span>
</span><span class='line'>  <span class="n">sluggable_column</span> <span class="ss">:name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, the <code>name</code> column from the categories table is being sent to the <code>sluggable_column</code> method as a
symbol.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">sluggable_column</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">slug_column</span> <span class="o">=</span> <span class="n">column_name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>sluggable_column</code> method takes <code>:name</code> and sets the <code>slug_column</code> attribute equal to <code>:name</code>.
Therefore, <code>self.class.slug_column</code> is equal to <code>:name</code> as demonstrated in the rails console:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">category</span> <span class="o">=</span> Category.first
</span><span class='line'>category.class.slug_column
</span><span class='line'><span class="o">=</span>&gt; :name
</span></code></pre></td></tr></table></div></figure>


<p> Now we can read:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">the_slug</span> <span class="o">=</span> <span class="n">to_slug</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">slug_column</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">the_slug</span> <span class="o">=</span> <span class="n">to_slug</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>self.send(:name)</code> is the same as <code>self.name</code> so we can just read this as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">the</span> <span class="n">slug</span> <span class="o">=</span> <span class="n">to_slug</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now I can explain what the <code>to_slug</code> method does.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">to_slug</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">name</span><span class="o">.</span><span class="n">parameterize</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>self.name</code>returns a string and the <code>parameterize</code> method is being called on that string. The
<code>parameterize</code> method replaces special characters in a string so that it may be used as part of a ‘pretty’ URL.
The <code>parameterize</code> method doesn&rsquo;t replace the underscore character so <code>gsub</code> is called on the string to remove any underscore and then
downcase is called on it to remove all uppercase characters. This way we&rsquo;ll have a string that can be used in a URL.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">generate_slug</span>
</span><span class='line'>  <span class="n">the_slug</span> <span class="o">=</span> <span class="n">to_slug</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">slug_column</span><span class="p">))</span>
</span><span class='line'>  <span class="c1">#in our ongoing example, the line above becomes: the_slug = &quot;programming&quot;</span>
</span><span class='line'>  <span class="c1">#in our ongoing example, the line below becomes:</span>
</span><span class='line'>  <span class="c1">#object = Category.find_by(slug: &quot;programming&quot;)</span>
</span><span class='line'>  <span class="n">object</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">slug</span><span class="p">:</span> <span class="n">the_slug</span><span class="p">)</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case <code>object</code> will equal <code>nil</code> because we haven&rsquo;t saved the new category to the database yet and we are assuming
I didn&rsquo;t already save a category named &ldquo;programming&rdquo;. Since <code>object</code>
is nil, the while loop will be skipped. This line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">self</span><span class="o">.</span><span class="n">slug</span> <span class="o">=</span> <span class="n">the_slug</span>
</span></code></pre></td></tr></table></div></figure>


<p>sets the slug column equal to &ldquo;programming&rdquo;. Since we called
<code>before_save :generate_slug</code> the slug will be generated in the create action when
<code>@category = Category.new(category_params)</code> is called. Then the slug will be saved to the database with the <code>@category</code> instance
when the create action calls <code>@category.save</code>.</p>

<p>Let&rsquo;s say there is already a &ldquo;programming&rdquo; category and a user creates a category named &ldquo;programming&rdquo; again. We
don&rsquo;t want different pages to have identical URLs. The solution is to append a suffix to
&ldquo;programming&rdquo; and make sure that suffix is never the same. This example might seem contrived, but if you are
generating the slug based on, say, the title of a post instead of the name of a category, then it is realistic to think
more than one user might have thought of the same post title. Another way around this is to validate the uniqueness of the
sluggable column in the model, but appending a suffix like this allows for flexibility in design and adds a layer
of protection against duplicate URLs.</p>

<p>Continuing with our example, since there is already an instance of Category with &ldquo;programming&rdquo; in the slug column, this time <code>object</code> will not be
equal to <code>nil</code> at this point in the method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">object</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">slug</span><span class="p">:</span> <span class="n">the_slug</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>so the first condition of the while loop will be met. The second condition is that <code>object</code> not
be equal to <code>self</code>. That condition is necessary in case <code>self</code> is only being updated. If <code>self</code> is being updated,
<code>object</code> will equal <code>self</code> and we don&rsquo;t want to append anything to the URL. In the case where <code>self</code> is being created <code>object</code>
will instead be equal to the previous instance of Category with &ldquo;programming&rdquo; in the slug column
so both conditions of the while loop will be true. In the line below <code>the_slug</code> is being set to &ldquo;programming-2&rdquo;.
Let&rsquo;s look at how the <code>append_suffix</code> method works.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">the_slug</span> <span class="o">=</span> <span class="n">append_suffix</span><span class="p">(</span><span class="n">the_slug</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first line of the <code>append_suffix</code> method is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="n">the_slug</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">to_i</span> <span class="o">!=</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is saying, since the <code>parameterize</code> method used inside the <code>to_slug</code> method generates
a string that replaces spaces with dashes, <code>the_slug</code> should either be a one word string,
or it should be a string of any number of words separated by dashes instead of spaces.
Therefore, call split on that string to get an array formatted like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">the_slug</span> <span class="o">=</span> <span class="s2">&quot;a-url-safe-string&quot;</span>
</span><span class='line'>the_slug.split<span class="o">(</span><span class="s1">&#39;-&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">=</span>&gt; <span class="o">[</span><span class="s2">&quot;a&quot;</span>, <span class="s2">&quot;url&quot;</span>, <span class="s2">&quot;safe&quot;</span>, <span class="s2">&quot;string&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>then it takes the last element in that array and calls <code>to_i</code> on it. Calling <code>to_i</code> on
a string of letters returns 0, and calling <code>to_i</code> on a string that only contains a Fixnum or a Float
returns the appropriate integer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">append_suffix</span><span class="p">(</span><span class="n">the_slug</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">the_slug</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">to_i</span> <span class="o">!=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">the_slug</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">count</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">the_slug</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">count</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Therefore, this is saying if the last element in the array is a number, then take all the elements
but the last one in that array and put them into a string, separating them with a
dash. Then add a dash to the end of the string and then add the integer <code>count</code> equals to the end
of the string such that if <code>the_slug</code> was <code>"programming-2"</code> it would become <code>"programming-3"</code>
Otherwise, the last element in the array is not a number, so just add a dash to the end of <code>the_slug</code> and
then add the integer <code>count</code> equals to the end of <code>the_slug</code> such that if <code>the_slug</code> was <code>"programming"</code>
it would become <code>"programming-2"</code>.</p>

<p>Now, back to the next line of the while loop inside the <code>generate_slug</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">object</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">slug</span><span class="p">:</span> <span class="n">the_slug</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is resetting <code>object</code>. If there is an instance of Category saved in the database
with a slug value equal to <code>the_slug</code> then <code>object</code> will be truthy so the loop will continue.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">generate_slug</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>  <span class="k">while</span> <span class="n">object</span> <span class="o">&amp;&amp;</span> <span class="n">object</span> <span class="o">!=</span> <span class="nb">self</span>
</span><span class='line'>    <span class="n">the_slug</span> <span class="o">=</span> <span class="n">append_suffix</span><span class="p">(</span><span class="n">the_slug</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="n">object</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">slug</span><span class="p">:</span> <span class="n">the_slug</span><span class="p">)</span>
</span><span class='line'>    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">slug</span> <span class="o">=</span> <span class="n">the_slug</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next time around <code>count</code> will be one number greater which means <code>the_slug</code>
will have a different number appended to it which means <code>object</code> will be
set to something different. This loop will continue until <code>object</code> is falsy which means <code>the_slug</code> is
finally a unique string.</p>

<p>Finally, the last line of the <code>generate_slug</code> method sets the slug column of <code>self</code>
to the string <code>the_slug</code> was set to. (<code>self</code> is the object <code>generate_slug</code> is being called on.
The example I&rsquo;ve used throughout this post has been <code>@category.generate_slug</code>)
When <code>@category</code> is saved in the create action, <code>@category.slug</code> will equal something like &ldquo;programming-2&rdquo;.
Now wherever you look up a resource that has been slugified you have to change this format:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@category</span> <span class="o">=</span> <span class="no">Category</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@category</span> <span class="o">=</span> <span class="no">Category</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">slug</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>because <code>find</code> will look for a primary key, but <code>params[:id]</code> returns a slug now
since the <code>to_param</code> method is overridden to return the slug instead of the primary key.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Self Referential Associations in Rails]]></title>
    <link href="http://durrellchamorro.github.io/blog/2015/10/05/self-referential-associations-in-rails/"/>
    <updated>2015-10-05T12:25:45-07:00</updated>
    <id>http://durrellchamorro.github.io/blog/2015/10/05/self-referential-associations-in-rails</id>
    <content type="html"><![CDATA[<p>In this post I&rsquo;ll compare and contrast different database associations in rails with the goal of
explaining how to set up self referential associations in rails. My conclusion is the conventions
rails provides don&rsquo;t always make code easier to read.<!--more--></p>

<p>Rails makes it easy to associate different models with one another. Take these
two models as a straight forward example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">God</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:human</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Human</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span><span class="err">“</span><span class="n">humans</span><span class="err">”</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:gods</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this model <code>self.table_name = “humans”</code> tells rails to look for a table
named <code>humans</code> instead of <code>humen</code> which it will automatically look for
with a model named <code>Human</code>. This can be demonstrated by typing the following
command into the rails console:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>“human”.tableize <span class="o">=</span>&gt; “humen”
</span></code></pre></td></tr></table></div></figure>


<p>So long as you have a foreign key called <code>human_id</code> in the gods table, rails
will figure out the association and let you call things like</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zeus.human <span class="o">=</span>&gt; <span class="c">#&lt;Human id: 1, name: “bob&quot;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p> and</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bob.gods <span class="o">=</span>&gt; <span class="c">#&lt;ActiveRecord::Associations::CollectionProxy [#&lt;God id: 1, name: &quot;Zeus&quot;, human_id: 1&gt;, #&lt;God id: 2, name: &quot;Athena&quot;, human_id: 1&gt;]&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>has_many :gods</code> line in the Human model is just a rails convention for the following method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">gods</span>
</span><span class='line'>    <span class="no">God</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">human_id</span><span class="p">:</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see from the above method, rails assumes you are querying the gods table and it assumes you are looking for the foreign key in the gods table that equals the primary key of the object the <code>gods</code> method is being called on.</p>

<p>Likewise, the <code>belongs_to :human</code> line in the God model is a rails convention for the following method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">human</span>
</span><span class='line'>    <span class="no">Human</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">human_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see from the method above, rails assumes you are querying the humans table for the primary key that equals the foreign key (in this case the foreign key is human_id) of the object (in the example above the object was zeus) the <code>human</code> method is being called on. It automatically looks for a foreign key called <code>human_id</code> by convention as well since the relationship is <code>belongs to :human</code></p>

<p>The rails conventions work beautifully for the above situation, but if you wanted to show a god has many human followers and a human follows many different gods? The <code>belongs_to :human</code> line above doesn’t allow you to call <code>zeus.humans</code> to get a list of humans. It only allows  you to call <code>zeus.human</code> to get one human. To fix this we need to set up a many to many relationship.</p>

<p>First we’ll create a new table called <code>relationships</code>. The model that hooks up to that table will look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:god</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:human</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The relationships table will have foreign keys called <code>god_id</code> and <code>human_id</code>. The God model will need to be changed to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">God</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:relationships</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:humans</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:relationships</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If the relationships table has a row with god_id equal to 1 and human_id equal to 1 and another row with god_id equal
to 1 and human_id equal to 2 and we do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">zeus</span> <span class="o">=</span> God.first
</span></code></pre></td></tr></table></div></figure>


<p>then we get this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>zeus.humans <span class="o">=</span>&gt; <span class="c">#&lt;ActiveRecord::Associations::CollectionProxy [#&lt;Human id: 2, name: &quot;marcus&quot;&gt;, #&lt;Human id: 1, name: &quot;maximus&quot;&gt;]&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>the rails convention <code>has_many :humans, through: :relationships</code> is the same as writing this method. The difference
is the convention returns an ActiveRecord_Associations_CollectionProxy and the
method below returns an array. This is a minor difference because you just need
to call <code>to_a</code> on it to turn it into an array.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">humans</span>
</span><span class='line'>  <span class="no">Human</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="no">Relationship</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">god_id</span><span class="p">:</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:human_id</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see from the method, this convention assumes you are querying the
relationships table for all entries where the god_id foreign key is equal to the
primary key of the object the <code>humans</code> method is being called on.  It then
assumes you want a list of all the humans
whose primary key equals the human_id foreign key in the list of relationships
it got from the previous query.</p>

<p>If the relationships table has a row with god_id equal to 1 and human_id equal
to 1 and another row with god_id equal to 2 and human_id equal to 1, and we do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">max</span> <span class="o">=</span> Human.first
</span></code></pre></td></tr></table></div></figure>


<p>then we get this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>max.gods  <span class="o">=</span>&gt; <span class="c">#&lt;ActiveRecord::Associations::CollectionProxy [#&lt;God id: 1, name: &quot;Zeus&quot;, human_id: 1&gt;, #&lt;God id: 2, name: &quot;Athena&quot;, human_id: 1&gt;]&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The rails convention</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">has_many</span><span class="p">:</span> <span class="n">gods</span><span class="p">,</span> <span class="ss">through</span><span class="p">:</span> <span class="ss">:relationships</span>
</span></code></pre></td></tr></table></div></figure>


<p>is the same as writing the method below. The difference is the convention returns
an ActiveRecord_Associations_CollectionProxy and the method below returns an
array. This is a minor difference because you just need to call <code>to_a</code> on
it to turn it into an array.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">def</span> <span class="nf">gods</span>
</span><span class='line'>   <span class="no">God</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="no">Relationship</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">human_id</span><span class="p">:</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:god_id</span><span class="p">))</span>
</span><span class='line'> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see from the method, this convention assumes you are querying the relationships table for all entries where the human_id foreign key is equal to the primary key of the object the <code>gods</code> method is being called on.  It then assumes you want a list of all the gods
whose primary key equals the god_id foreign key in the list of relationships it
got from the previous query.</p>

<p>What if you want a list of all the children and all the parents of a particular god? This sort of request is a self referential association. Instead of asking for associated data in another table as in humans associated with gods, you are asking for associated data within the same table as in gods associated with gods. This means the conventions above wont work because the assumptions explained above that rails makes will be wrong. Therefore, you have to explicitly tell rails where to look.</p>

<p>The Relationship model will need two additional lines as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:god</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:human</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:parent</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">&quot;God&quot;</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:child</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">&quot;God&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we are naming the relationship as <code>parent</code> and <code>child</code> but we don’t
want rails to look for the <code>Parent</code> class/model and the <code>Child</code> class/model because
those classes/models don’t exist. Therefore we have to explicitly tell rails to look
for the God class/model.</p>

<p>The God class will need these two additional lines of code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_many</span> <span class="ss">:children</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">&quot;Relationship&quot;</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="ss">:parent_id</span>
</span><span class='line'><span class="n">has_many</span> <span class="ss">:parents</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">&quot;Relationship&quot;</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="ss">:child_id</span>
</span></code></pre></td></tr></table></div></figure>


<p>We need to explicitly tell rails the class name is Relationship otherwise it will
look for the Child and Parent classes. Then we need to tell rails the foreign
key names we want. In this case we are looking for the parent_id foreign keys
in the <code>relationships</code> table and we want to access that data by calling a method named <code>children</code>. We are also looking for the child_id foreign keys in the relationships table and we want to access that data by calling a method named <code>parents</code></p>

<p>There is still a little convention at play. We are naming the methods
<code>children</code> and <code>parents</code> since the Relationship model has <code>belongs_to :parent, class_name: "God"</code>
and <code>belongs_to :child, class_name: “God”</code> which tell rails to associate the two classes.</p>

<p>This line</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_many</span> <span class="ss">:children</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">&quot;Relationship&quot;</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="ss">:parent_id</span>
</span></code></pre></td></tr></table></div></figure>


<p>is essentially the same as writing this method below with the exception that the method
below returns a Relationship::ActiveRecord_Relation and the convention above returns
an ActiveRecord_Associations_CollectionProxy, both of which can be turned
into an array by calling <code>to_a</code> on them.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">children</span>
</span><span class='line'>  <span class="no">Relationship</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">parent_id</span><span class="p">:</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>With all this being said, I think this example shows the conventions in rails don&rsquo;t
always make the code easier to read. To me, it&rsquo;s easier to understand what is going on
in the method above than in the convention below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">has_many</span> <span class="ss">:children</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">&quot;Relationship&quot;</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="ss">:parent_id</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Be Aware of App Not Being Aware of Database Data]]></title>
    <link href="http://durrellchamorro.github.io/blog/2015/08/17/be-aware-of-app-not-being-aware-of-database-data/"/>
    <updated>2015-08-17T14:40:25-07:00</updated>
    <id>http://durrellchamorro.github.io/blog/2015/08/17/be-aware-of-app-not-being-aware-of-database-data</id>
    <content type="html"><![CDATA[<p>When you write a database backed app, you need to be aware that the app isn&rsquo;t always aware
of new data that recently hit the database. For example,<!--more--> say you have a
method like this that deals one card to a player or dealer:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">deal_one_card</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">hand</span><span class="p">)</span>
</span><span class='line'>   <span class="n">card</span> <span class="o">=</span> <span class="no">Card</span><span class="o">.</span><span class="n">deal_one</span>
</span><span class='line'>   <span class="k">if</span> <span class="n">role</span><span class="o">.</span><span class="n">class</span> <span class="o">==</span> <span class="no">Player</span>
</span><span class='line'>     <span class="n">card</span><span class="o">.</span><span class="n">player_id</span> <span class="o">=</span> <span class="n">current_player</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>     <span class="n">card</span><span class="o">.</span><span class="n">hand_id</span> <span class="o">=</span> <span class="n">hand</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>   <span class="k">else</span>
</span><span class='line'>     <span class="n">card</span><span class="o">.</span><span class="n">dealer_id</span> <span class="o">=</span> <span class="n">dealer</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>     <span class="n">card</span><span class="o">.</span><span class="n">hand_id</span> <span class="o">=</span> <span class="n">hand</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>   <span class="n">card</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>and you have a loop like this that will continue adding cards to the dealers hand until
the total of the dealer&rsquo;s hand sums to at least 17</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">while</span> <span class="n">total</span><span class="p">(</span><span class="n">dealer</span><span class="o">.</span><span class="n">hand</span><span class="o">.</span><span class="n">cards</span><span class="p">)</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span><span class="o">::</span><span class="no">DEALER_MINIMUM</span>
</span><span class='line'>  <span class="n">deal_one_card</span><span class="p">(</span><span class="n">dealer</span><span class="p">,</span> <span class="n">dealer</span><span class="o">.</span><span class="n">hand</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As the <code>deal_one_card</code> method above is written the card will be saved in the
database with the proper attributes linking it to the dealer&rsquo;s hand,
however the rails app will not be aware of this change in the database while inside the loop
so when it totals the dealer&rsquo;s cards, the total will never increase. Therefore if the total was &lt; 17
entering the loop, it will stay &lt; 17 and the loop will go on infinitely.</p>

<p>In order to let the app know how the <code>deal_one_card</code> method changed the database
you must reload the hand like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">while</span> <span class="n">total</span><span class="p">(</span><span class="n">dealer</span><span class="o">.</span><span class="n">hand</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">cards</span><span class="p">)</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span><span class="o">::</span><span class="no">DEALER_MINIMUM</span>
</span><span class='line'>  <span class="n">deal_one_card</span><span class="p">(</span><span class="n">dealer</span><span class="p">,</span> <span class="n">dealer</span><span class="o">.</span><span class="n">hand</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This was a nasty bug I had the toughest time figuring out and I&rsquo;m very thankful to Brandon
at <a href="https://launchschool.com">Launch School</a> for figuring this one out and explaining it to me.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Magic With Partials]]></title>
    <link href="http://durrellchamorro.github.io/blog/2015/07/03/rails-magic-with-partials/"/>
    <updated>2015-07-03T06:33:02-07:00</updated>
    <id>http://durrellchamorro.github.io/blog/2015/07/03/rails-magic-with-partials</id>
    <content type="html"><![CDATA[<p>When you want to send a collection of objects to a partial you can use Rails
conventions to eliminate code if you know what rails automatically assumes.</p>

<!--more-->


<p>Normally, for a partial containing the code in Example 2 you would
write something like this in the view:</p>

<p>Example 1</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">render</span> <span class="s2">&quot;shared/title&quot;</span><span class="p">,</span> <span class="ss">title</span><span class="p">:</span> <span class="s2">&quot;All Posts&quot;</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>where <code>”shared/title"</code> is the relative path to the partial and <code>title:</code>
is the name of the local variable in the partial, and <code>”All Posts”</code> is the
string that local variable will be set to. It is important to remember the actual
partial needs to have an underscore in front of it so the actual file in this
example is <code>_title.html.erb</code> but it is just referenced as <code>title</code> as
shown above.</p>

<p>Example 2</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;&lt;%=</span> <span class="n">title</span> <span class="sx">%&gt;&lt;/h3&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is where you can take advantage of Rails conventions and assumptions. Let’s
say you have an object <code>@posts</code> that is set in your Controller to your Post
model like this: <code>@posts = Post.all</code> so <code>@posts</code> contains many post
objects, and each post has its own categories. Instead of writing all this:</p>

<p>Example 3</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% @posts.each </span><span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;% post.categories.each do |category| %&gt;</span>
</span><span class='line'>    <span class="o">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;/categories/category&#39;</span><span class="p">,</span> <span class="ss">category</span><span class="p">:</span> <span class="n">category</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;% end %&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can simply write:</p>

<p>Example 4</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">% @posts.each </span><span class="k">do</span>  <span class="o">|</span><span class="n">post</span><span class="o">|</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">  &lt;%= render post.categories %&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The partial for Example 4 might look something like this:</p>

<p>Example 5</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">link_to</span> <span class="n">category</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">post_path</span><span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In Example 4 the resources we are rendering are categories. Rails will assume
there is a folder named after those resources that contains a partial named
after the singular of those resources. Given that knowledge, all we have to do
is create a <code>categories</code> folder relative to the view and put a
<code>category.html.erb</code> file in it that contains the code in Example 5.</p>
]]></content>
  </entry>
  
</feed>
